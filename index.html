<script>
  async function bereken() {
    const data = Object.fromEntries(
      [...new FormData(document.getElementById("form")).entries()]
        .map(([k, v]) => [k, v.replace(',', '.')])
    );

    try {
      const response = await fetch("https://bellade-tool.onrender.com/bereken", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error("Serverfout: " + response.status);
      }

      const res = await response.json();

      document.getElementById("omzet").textContent = res.omzet + ' €';
      document.getElementById("energiekost").textContent = res.energiekost + ' €';
      document.getElementById("capaciteitskost").textContent = res.capaciteitskost + ' €';
      document.getElementById("huurprijs").textContent = res.huurprijs + ' €';
      document.getElementById("energiehoeveelheid").textContent = res.energiehoeveelheid + ' kWh';
      document.getElementById("terugverdentijd").textContent = res.terugverdentijd + ' maanden';
      document.getElementById("jaarlijksrendement").textContent = res.rendement_jaarlijks + ' %';

      if (window.barChart) window.barChart.destroy();
      window.barChart = new Chart(document.getElementById("barChart"), {
        type: 'bar',
        data: {
          labels: ['Omzet', 'Energiekost', 'Capaciteit', 'Huur'],
          datasets: [{
            label: '€',
            data: [res.omzet, res.energiekost, res.capaciteitskost, res.huurprijs],
            backgroundColor: ['#00FC63', '#005A00', '#373736', '#888']
          }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });

      if (window.lineChart) window.lineChart.destroy();
      window.lineChart = new Chart(document.getElementById("lineChart"), {
        type: 'line',
        data: {
          labels: Array.from({ length: 144 }, (_, i) => i + 1),
          datasets: [{
            label: 'Cumulatief rendement',
            data: res.grafiek_data,
            borderColor: '#005A00',
            fill: false,
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: false } }
        }
      });
    } catch (error) {
      alert("Fout bij berekening: " + error.message);
      console.error("Berekenfout:", error);
    }
  }
</script>
